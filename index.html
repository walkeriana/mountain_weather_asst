<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>Mountain Weather Selector v6.1</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
body { font-family: sans-serif; }
button { margin: 3px; }
hr { margin: 15px 0; }
.region-title { font-size: 18px; margin-top:20px; }
.jump-link { margin-right:10px; }
</style>
</head>
<body>

<h2>â›° å±±å²³æ°—è±¡é¸å®šã‚·ã‚¹ãƒ†ãƒ  v6.1</h2>

<h3>ğŸ“‚ ãƒ‡ãƒ¼ã‚¿ç®¡ç†</h3>
<button onclick="newData()">ğŸ†• æ–°è¦ä½œæˆ</button>
<input type="file" id="fileInput">
<button onclick="downloadJSON()">ğŸ’¾ iPhoneä¿å­˜(JSON)</button>

<hr>

<h3>â›° å±±ç™»éŒ²</h3>
<input type="text" id="mountainName" placeholder="å±±å">
<button onclick="searchMountain()">æ¤œç´¢</button>
<br><br>

<label>æ¨™é«˜(m)ï¼š</label>
<input type="number" id="elevation"><br><br>

<label>å±±åŸŸï¼š</label>
<select id="region">
<option>åŒ—ã‚¢ãƒ«ãƒ—ã‚¹</option>
<option>å—ã‚¢ãƒ«ãƒ—ã‚¹</option>
<option>ä¸­å¤®ã‚¢ãƒ«ãƒ—ã‚¹</option>
<option>å…«ãƒ¶å²³</option>
<option>å¥¥ç§©çˆ¶</option>
<option>å¥¥å¤šæ‘©</option>
<option>ä¸¹æ²¢</option>
<option>éˆ´é¹¿å±±è„ˆ</option>
<option>å¥¥ç¾½å±±è„ˆ</option>
<option>ä¸­å›½å±±åœ°</option>
<option>å››å›½å±±åœ°</option>
<option>ä¹å·å±±åœ°</option>
<option>ãã®ä»–</option>
</select>

<div id="searchResults"></div>
<button onclick="registerMountain()">ç™»éŒ²</button>

<hr>

<h3>ğŸ•’ è¡¨ç¤ºæ™‚é–“ï¼ˆæ—¥æœ¬æ™‚é–“ï¼‰</h3>
<input type="datetime-local" id="jstTime">

<hr>

<h3>ğŸ“Œ å±±åŸŸã‚¸ãƒ£ãƒ³ãƒ—</h3>
<div id="regionJump"></div>

<hr>

<h3>ğŸ†• æœ€è¿‘ç™»éŒ²ï¼ˆå³æ°—è±¡ã‚¢ã‚¯ã‚»ã‚¹ï¼‰</h3>
<div id="latest"></div>

<hr>

<h3>ğŸ“‹ ç™»éŒ²æ¸ˆã¿å±±ä¸€è¦§</h3>
<div id="mountainList"></div>

<script>

let mountains = [];
let selectedSearchResult = null;

window.onload = function(){
  const now = new Date();
  now.setMinutes(0);
  now.setSeconds(0);
  const iso = now.toISOString().slice(0,16);
  document.getElementById("jstTime").value = iso;
};

/* æ–°è¦ */
function newData(){
  mountains = [];
  renderList();
}

/* â˜… iPhoneæœ€é©ä¿å­˜ï¼ˆMIMEä¿®æ­£ï¼šè¶…é‡è¦ï¼‰ */
function downloadJSON(){
  const data = JSON.stringify(mountains, null, 2);
  const blob = new Blob([data], {
    type: "application/octet-stream"  // â† iOSå®‰å®š
  });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "mountains.json";
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
}

/* èª­è¾¼ */
document.getElementById("fileInput").addEventListener("change", function(e){
  const reader = new FileReader();
  reader.onload = function(evt){
    mountains = JSON.parse(evt.target.result);
    renderList();
  };
  reader.readAsText(e.target.files[0]);
});

/* å±±æ¤œç´¢ */
async function searchMountain(){
  const name = document.getElementById("mountainName").value.trim();
  const url = `https://nominatim.openstreetmap.org/search?format=json&countrycodes=jp&q=${encodeURIComponent(name+" peak")}&addressdetails=1&limit=5`;
  const res = await fetch(url);
  const data = await res.json();
  showSearchResults(data);
}

function showSearchResults(results){
  const container = document.getElementById("searchResults");
  container.innerHTML = "";

  results.forEach(async item=>{
    if(item.class!=="natural"||item.type!=="peak") return;

    const lat=parseFloat(item.lat);
    const lon=parseFloat(item.lon);

    const prefecture =
      item.address?.state ||
      item.address?.region ||
      item.address?.county ||
      item.address?.province ||
      "ä¸æ˜";

    const btn=document.createElement("button");
    btn.innerText=`${item.display_name.split(",")[0]}ï¼ˆ${prefecture}ï¼‰`;

    btn.onclick=async function(){
      selectedSearchResult={lat,lon,prefecture};
      const elevRes=await fetch(`https://api.open-elevation.com/api/v1/lookup?locations=${lat},${lon}`);
      const elevData=await elevRes.json();
      document.getElementById("elevation").value=elevData.results[0].elevation;
      container.innerHTML="é¸æŠæ¸ˆã¿ âœ”";
    };
    container.appendChild(btn);
  });
}

/* ç™»éŒ²ï¼ˆå…ˆé ­è¿½åŠ ï¼‰ */
function registerMountain(){
  const name=document.getElementById("mountainName").value.trim();
  if(!selectedSearchResult) return alert("å±±ã‚’æ¤œç´¢ã—ã¦é¸æŠã—ã¦ãã ã•ã„");

  const newMountain = {
    name:name,
    lat:selectedSearchResult.lat,
    lon:selectedSearchResult.lon,
    elevation:parseInt(document.getElementById("elevation").value),
    prefecture:selectedSearchResult.prefecture,
    region:document.getElementById("region").value
  };

  mountains.unshift(newMountain);
  renderList();
}

/* â˜… æ°—åœ§è‡ªå‹•åˆ¤å®šï¼ˆ950â†’1000hPaä¿®æ­£ï¼‰ */
function autoPressure(elev){
  if(elev < 500) return "1000hPa";
  if(elev < 1800) return "850hPa";
  if(elev < 3200) return "700hPa";
  return "500hPa";
}

/* JSTâ†’UTCï¼ˆä¿®æ­£ç‰ˆç¶­æŒï¼‰ */
function convertToUTC(jst){
  const [datePart,timePart]=jst.split("T");
  const [y,m,d]=datePart.split("-");
  const [h]=timePart.split(":");

  return new Date(Date.UTC(
    parseInt(y),
    parseInt(m)-1,
    parseInt(d),
    parseInt(h)-9
  ));
}

function openEarth(m,overlay){
  const jst=document.getElementById("jstTime").value;
  const utc=convertToUTC(jst);

  const yyyy=utc.getUTCFullYear();
  const mm=String(utc.getUTCMonth()+1).padStart(2,"0");
  const dd=String(utc.getUTCDate()).padStart(2,"0");
  const hh=String(utc.getUTCHours()).padStart(2,"0");

  const pressure=autoPressure(m.elevation);

  const url=
  `https://earth.nullschool.net/jp/#${yyyy}/${mm}/${dd}/${hh}00Z/wind/isobaric/${pressure}/overlay=${overlay}/orthographic=${m.lon},${m.lat},4000/loc=${m.lon},${m.lat}`;

  window.location.href = url;
}

function createOverlayButtons(m){
  const div=document.createElement("div");
  const overlays=[
    {label:"ğŸŒ« ç›¸å¯¾æ¹¿åº¦",value:"relative_humidity"},
    {label:"ğŸŒ¡ æ°—æ¸©",value:"temp"},
    {label:"â˜” 3æ™‚é–“é™æ°´",value:"precip_3hr"},
    {label:"ğŸ’§ å¯é™æ°´é‡",value:"total_precipitable_water"}
  ];
  overlays.forEach(o=>{
    const btn=document.createElement("button");
    btn.innerText=o.label;
    btn.onclick=()=>openEarth(m,o.value);
    div.appendChild(btn);
  });
  return div;
}

function renderList(){
  const container=document.getElementById("mountainList");
  const latest=document.getElementById("latest");
  const regionJump=document.getElementById("regionJump");

  container.innerHTML="";
  latest.innerHTML="";
  regionJump.innerHTML="";

  if(mountains.length===0) return;

  /* â˜… æœ€æ–°ï¼‹overlayãƒœã‚¿ãƒ³è¿½åŠ  */
  const newest = mountains[0];
  const latestDiv=document.createElement("div");
  latestDiv.innerHTML=`<strong>${newest.name}</strong>ï¼ˆ${newest.prefecture} / ${newest.elevation}mï¼‰<br>`;
  latestDiv.appendChild(createOverlayButtons(newest));
  latest.appendChild(latestDiv);

  const grouped = {};
  mountains.forEach(m=>{
    if(!grouped[m.region]) grouped[m.region]=[];
    grouped[m.region].push(m);
  });

  Object.keys(grouped).forEach(region=>{
    const link=document.createElement("a");
    link.href="#"+region;
    link.className="jump-link";
    link.innerText=region;
    regionJump.appendChild(link);
  });

  Object.keys(grouped).forEach(region=>{
    const regionDiv=document.createElement("div");
    regionDiv.id=region;
    regionDiv.innerHTML=`<div class="region-title">â–  ${region}ï¼ˆ${grouped[region].length}ï¼‰</div>`;

    grouped[region].forEach(m=>{
      const div=document.createElement("div");
      div.innerHTML=`${m.name}ï¼ˆ${m.prefecture} / ${m.elevation}mï¼‰<br>`;
      div.appendChild(createOverlayButtons(m));
      regionDiv.appendChild(div);
      regionDiv.appendChild(document.createElement("hr"));
    });

    container.appendChild(regionDiv);
  });
}

</script>
</body>
</html>