<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>Mountain Weather Selector v5</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
body { font-family: sans-serif; }
button { margin: 3px; }
hr { margin: 15px 0; }
</style>
</head>
<body>

<h2>â›° å±±å²³æ°—è±¡é¸å®šã‚·ã‚¹ãƒ†ãƒ  v5</h2>

<h3>ğŸ“‚ ãƒ‡ãƒ¼ã‚¿ç®¡ç†</h3>
<button onclick="newData()">ğŸ†• æ–°è¦ä½œæˆ</button>
<input type="file" id="fileInput">
<button onclick="downloadJSON()">ğŸ’¾ JSONä¿å­˜</button>

<hr>

<h3>â›° å±±ç™»éŒ²</h3>
<input type="text" id="mountainName" placeholder="å±±å">
<button onclick="searchMountain()">æ¤œç´¢</button>
<br><br>

<label>æ¨™é«˜(m)ï¼š</label>
<input type="number" id="elevation"><br><br>

<label>å±±åŸŸï¼š</label>
<select id="region">
<option>åŒ—ã‚¢ãƒ«ãƒ—ã‚¹</option>
<option>å—ã‚¢ãƒ«ãƒ—ã‚¹</option>
<option>ä¸­å¤®ã‚¢ãƒ«ãƒ—ã‚¹</option>
<option>å…«ãƒ¶å²³</option>
<option>å¥¥ç§©çˆ¶</option>
<option>å¥¥å¤šæ‘©</option>
<option>ä¸¹æ²¢</option>
<option>éˆ´é¹¿å±±è„ˆ</option>
<option>å¥¥ç¾½å±±è„ˆ</option>
<option>ä¸­å›½å±±åœ°</option>
<option>å››å›½å±±åœ°</option>
<option>ä¹å·å±±åœ°</option>
<option>ãã®ä»–</option>
</select>

<div id="searchResults"></div>
<button onclick="registerMountain()">ç™»éŒ²</button>

<hr>

<h3>ğŸ•’ è¡¨ç¤ºæ™‚é–“ï¼ˆæ—¥æœ¬æ™‚é–“ï¼‰</h3>
<input type="datetime-local" id="jstTime">

<hr>

<h3>ğŸ“‹ ç™»éŒ²æ¸ˆã¿å±±ä¸€è¦§</h3>
<div id="mountainList"></div>

<script>

let mountains = {};
let selectedSearchResult = null;

/* åˆæœŸæ™‚é–“ï¼ˆç¾åœ¨ã®00åˆ†ï¼‰ */
window.onload = function(){
  const now = new Date();
  now.setMinutes(0);
  now.setSeconds(0);
  const iso = now.toISOString().slice(0,16);
  document.getElementById("jstTime").value = iso;
};

/* æ–°è¦ */
function newData(){
  mountains = {};
  renderList();
}

/* JSONãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ */
function downloadJSON(){
  const data = JSON.stringify(mountains, null, 2);
  const blob = new Blob([data], {type:"application/json;charset=utf-8"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "mountains.json";
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
}

/* èª­è¾¼ */
document.getElementById("fileInput").addEventListener("change", function(e){
  const reader = new FileReader();
  reader.onload = function(evt){
    mountains = JSON.parse(evt.target.result);
    renderList();
  };
  reader.readAsText(e.target.files[0]);
});

/* å±±æ¤œç´¢ */
async function searchMountain(){
  const name = document.getElementById("mountainName").value.trim();
  const url = `https://nominatim.openstreetmap.org/search?format=json&countrycodes=jp&q=${encodeURIComponent(name+" peak")}&addressdetails=1&limit=5`;
  const res = await fetch(url);
  const data = await res.json();
  showSearchResults(data);
}

/* å€™è£œè¡¨ç¤º */
function showSearchResults(results){
  const container = document.getElementById("searchResults");
  container.innerHTML = "";

  results.forEach(async item=>{
    if(item.class!=="natural"||item.type!=="peak") return;

    const lat=parseFloat(item.lat);
    const lon=parseFloat(item.lon);

    const prefecture =
      item.address?.state ||
      item.address?.region ||
      item.address?.county ||
      item.address?.province ||
      "ä¸æ˜";

    const btn=document.createElement("button");
    btn.innerText=`${item.display_name.split(",")[0]}ï¼ˆ${prefecture}ï¼‰`;

    btn.onclick=async function(){
      selectedSearchResult={lat,lon,prefecture};

      const elevRes=await fetch(`https://api.open-elevation.com/api/v1/lookup?locations=${lat},${lon}`);
      const elevData=await elevRes.json();
      document.getElementById("elevation").value=elevData.results[0].elevation;

      container.innerHTML="é¸æŠæ¸ˆã¿ âœ”";
    };
    container.appendChild(btn);
  });
}

/* ç™»éŒ² */
function registerMountain(){
  const name=document.getElementById("mountainName").value.trim();
  if(!selectedSearchResult) return alert("å±±ã‚’æ¤œç´¢ã—ã¦é¸æŠã—ã¦ãã ã•ã„");

  mountains[name]={
    lat:selectedSearchResult.lat,
    lon:selectedSearchResult.lon,
    elevation:parseInt(document.getElementById("elevation").value),
    prefecture:selectedSearchResult.prefecture,
    region:document.getElementById("region").value
  };
  renderList();
}

/* æ¨™é«˜â†’æ°—åœ§ */
function autoPressure(elev){
  if(elev<600) return "950hPa";
  if(elev<1800) return "850hPa";
  if(elev<3200) return "700hPa";
  return "500hPa";
}

/* JSTâ†’UTC */
function convertToUTC(jst){
  const date=new Date(jst);
  date.setHours(date.getHours()-9);
  return date;
}

/* earthè¡¨ç¤º */
function openEarth(name,overlay){

  const m=mountains[name];
  const jst=document.getElementById("jstTime").value;
  const utc=convertToUTC(jst);

  const yyyy=utc.getUTCFullYear();
  const mm=String(utc.getUTCMonth()+1).padStart(2,"0");
  const dd=String(utc.getUTCDate()).padStart(2,"0");
  const hh=String(utc.getUTCHours()).padStart(2,"0");

  const pressure=autoPressure(m.elevation);

  const url=
  `https://earth.nullschool.net/jp/#${yyyy}/${mm}/${dd}/${hh}00Z/wind/isobaric/${pressure}/overlay=${overlay}/orthographic=${m.lon},${m.lat},4000/loc=${m.lon},${m.lat}`;

  window.location.href = url;
}

/* ä¸€è¦§è¡¨ç¤º */
function renderList(){
  const container=document.getElementById("mountainList");
  container.innerHTML="";
  Object.keys(mountains).forEach(name=>{
    const m=mountains[name];
    const div=document.createElement("div");

    div.innerHTML=`<strong>${name}</strong>ï¼ˆ${m.prefecture} / ${m.elevation}mï¼‰<br>`;

    const overlays=[
      {label:"ğŸŒ« ç›¸å¯¾æ¹¿åº¦",value:"relative_humidity"},
      {label:"ğŸŒ¡ æ°—æ¸©",value:"temp"},
      {label:"â˜” 3æ™‚é–“é™æ°´",value:"precip_3hr"},
      {label:"ğŸ’§ å¯é™æ°´é‡",value:"total_precipitable_water"}
    ];

    overlays.forEach(o=>{
      const btn=document.createElement("button");
      btn.innerText=o.label;
      btn.onclick=()=>openEarth(name,o.value);
      div.appendChild(btn);
    });

    container.appendChild(div);
    container.appendChild(document.createElement("hr"));
  });
}

</script>

</body>
</html>